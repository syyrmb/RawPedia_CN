本文采取CC BY-SA 3.0共享协议（https://creativecommons.org/licenses/by-sa/3.0/，在进行合适的署名，引用CC版权链接，并以同样的共享协议传播内容的前提下，可以自由地复制/分发内容，详见前面的链接）。

由于本人不熟悉Markdown，段落格式可能有问题，并且文中没有图片。由于本人水平有限，虽然经过了一次校对，但译文仍然仅供参考。

This article is shared under CC BY-SA 3.0 license. It was translated by me and went through proofread later, so the content should be accurate. However, formatting could be wrong (since I'm a Markdown noob) and I didn't bother adding pictures.

## 去马赛克

本工具的效果仅在1:1及其以上的放大倍率可见。使用细节窗口（点击主面板的）。

目录

1- 简介

2- 去马赛克方法

3- 如何选择最佳的去马赛克方法

4- 黑白相机

5- 界面

​    5-1 算法

​        5-1-1 双重去马赛克算法

​    5-2 边界

​    5-3 子图像

​    5-4 伪色抑制步长

## 简介

大部分数码相机使用的是一块传感器，它含有上百万个同质化的，被称作像点/感光点（sensels or photosites）的感光单元。为了捕获色彩，传感器的前面会铺设一层色彩滤光片（[color filter array](https://en.wikipedia.org/wiki/Color_filter_array) (CFA)），让感光点能够捕获某一波长的光。“拜耳滤镜”是最为常见的一种：它使用的是一个重复的，2x2的绿，蓝，红，绿阵列。这种阵列被大部分数码相机厂商使用。还有一种滤镜组合叫作“X-Trans”，它被某些富士相机使用，它使用的是一个重复的6x6阵列。由于每个感光点只能捕捉某一特定频段的光，这就出现了三个需要解决的问题：

1. 现在还没有颜色的概念，因为穿过滤镜的光子在击中感光点后，感光点记录的只是一个对应的电流大小。
2. 绿色感光点的数量比红色和蓝色多了一倍。
3. 因此，每个色彩通道都会有一半（绿色）或3/4（红色或蓝色）缺乏信息（黑色的，没有曝光的感光点，因为以红色为例，只有1/4的感光点前面有红色滤镜）。

所以展示出使用拜耳阵列/X-Trans阵列传感器所拍摄的照片并不是直截了当的：离散的数据点所形成的的马赛克需要被转化为令人信服的彩色图。这一过程被称为去马赛克。

RawTherapee提供多个去马赛克算法，每一个都有自身的特点。它们之间的区别可能很细微，你可能需要放大到100%甚至以上才能看到它们的区别。然而，由于经过去马赛克处理的照片才是被所有其他后期工具处理的照片，不同的去马赛克算法到最后可能会导致照片的观感相差极大，尤其是放大观看的时候。去马赛克算法所导致的最明显的观感差异包括细节渲染质量上的不同，以及迷宫状噪点的可见程度。

就拜耳阵列相机而言，AMaZE在一般情况下是最适合用于低ISO照片的，而LMMSE或IGV更适合用于高ISO照片。就X-Trans相机而言，3-Pass (Markesteijn)一般来说是最佳的选择。

顺便一提，Foveon X3传感器没有使用色彩滤镜阵列，所以用它拍出来的照片不需要进行去马赛克。但是RawTherapee不支持这种传感器所拍摄的照片。

RawTherapee的不同去马赛克算法对比

## 去马赛克算法

+ 一般算法：

​    **Fast**

​    一个非常快速，但是简陋，低质的去马赛克算法，不推荐使用。

​    **黑白**

​    只对黑白相机用户，或是移除了相机的色彩滤镜的用户有用。

​    **无**

​    不进行去马赛克。对于排查问题有用，但对于摄影来说没有意义。

+ 拜耳算法：

​    **AMaZE**

​    AMaZE（混叠最小化&拉链效应消除，Aliasing Minimization and Zipper Elimination）是默认的去马赛克方法，因为它在大多数情况下的表现都是最好的。在RawTherapee 2.4及之前，VNG4曾是推荐用于奥林巴斯相机的去马赛克算法，因为当时还没有AMaZE，而VNG4能消除某些其他算法可能会导致的迷宫状杂点。但RawTherapee 3.0发布后，奥林巴斯用户可能更应该使用本算法。

​    **RCD**

​    RCD（比例纠正去马赛克，Ratio Corrected Demosaicing）处理圆形边缘（比如天文摄影中的星星）的效果优良，同时细节的保留程度也与AMaZE几乎处在同一水平。

​    **DCB**

​    DCB的效果和AMaZE相似。AMaZE通常在恢复细节上略占优势，而DCB避免伪色的效果更好，尤其是在处理去低通滤镜相机的照片时。

​    **LMMSE和IGV**

​    推荐在噪点多的，高ISO的照片中使用这两种算法，并与降噪工具一同使用，它们可以避免迷宫状噪点的出现，也能避免重度降噪而导致的图片失色。IGV在减轻摩尔纹方面也非常有效。

​    **AHD, EAHD和HPHD**

​    AHD(自适应均匀定向，Adaptive Homogeneity-Directed)，EAHD（Horvath's AHD）以及HPHD (Heterogeneity-Projection Hard-Decision)是处理速度更慢，通常比其他算法更差的老算法。

​    **VNG4**

​    如果你使用技术性中画幅相机（medium format technical camera）并搭配了一个近似对称结构的广角镜头（如Schneider Digitar 28mm或35mm），那么传感器所捕捉的图像里面很可能会有一些感光点之间的串扰，尤其是当镜头移轴之后（因为这些镜头使光线入射角太低，导致某些光泄露到了相邻的另一个像素上），在这种情况下，由于串扰导致的绿色通道分离，使用AMaZE和DCB算法会生成迷宫状杂点。如果你把为胶片设计的广角镜头转接到无反相机上的话，串扰现象也有可能发生。这样的话，使用VNG4（可变数目梯度，Variable Number of Gradients）算法就是更好的选择，它可以很好地处理这种情况，代价是会损失一些细节。这种情况的替代解决方案是启用绿平衡来抵消绿色通道的差异。

​    **像素偏移**

​    某些宾得和索尼相机支持使用像素偏移模式进行拍摄，这些相机会连续拍摄4张照片，每拍摄完其中的1张照片就向圆周方向进行1个像素的运动，然后把4张照片保存到一个大的Raw文件里。RawTherapee可以自动将所有照片合并成1张，并自动遮盖动体，从而起到减少噪点，增加锐度的效果。

富士X-Trans算法：

​    **3-Pass**

​    适用于使用X-Trans传感器的富士相机。重复处理图像三次，获得更锐的结果（只有低ISO照片可以看到）。比1-Pass慢。

​    **1-Pass**

​    适用于使用X-Trans传感器的富士相机。速度比3-Pass更快，但画质更差，不过只有在低ISO图片中能看到区别。如果遇到处理速度问题，你可以在高ISO照片中使用这个算法，也不会产生可见的区别。

## 如何选择最佳的去马赛克方法

放大到至少100%（1:1）然后试一遍所有去马赛克算法，看看你觉得哪个更好。使用锐利，细节多的，有小图案的照片，比如呈波浪型的，重复的毛衣线（注意观察有没有迷宫状杂点），远处的砖墙，远处的圆形路标（注意观察圆形边缘的锯齿），低ISO和高ISO的照片都要进行测试。用你自己相机的照片进行测试，因为适合尼康Raw的算法不一定适合奥林巴斯的Raw。

## 黑白相机

黑白相机传感器的前面是一块同质性的滤镜，你获得的是一张黑白照片，不需要进行任何去马赛克。某些相机没有红外滤镜，因此对于红外光非常敏感，这对于创意型黑白摄影会有用处。

RawTherapee支持黑白相机，但是用户界面没有为其进行适配，所以加载黑白照片也会有色彩调整工具。

处理黑白照片时要考虑到一些额外的问题：某些黑白相机会告诉软件它们只有黑白通道以及中性色彩阵列（比如徕卡 M Monochrom），而其它相机会反馈拜耳阵列的RGB通道（如飞思IQ260 Achromatic和拆除了IR滤镜的相机）。如果相机只反馈了一条通道，RawTherapee就能识别照片，并且不进行任何去马赛克操作（去马赛克栏依然可用，但不会对图片造成影响），一切都会正常地运作。但是，如果相机反馈自己是有拜耳RGB阵列的相机，软件就会进行去马赛克操作并应用色彩阵列。此时你应该选择“黑白”去马赛克方法，并将色彩管理栏的*输入档案*修改为“无档案”，以中止软件的自动操作。

## 界面

去马赛克方法及其相关的设定被划分到了两个主要工具之下：“拜尔阵列传感器”和"Sensor with X-Trans Matrix"，显示的工具会根据传感器滤镜的不同而调整。一个工具的设定不会影响另一个。如果你打开了一张拜耳传感器的Raw文件，只有"拜尔阵列传感器"栏的设定会被应用，"Sensor with X-Trans Matrix"会被忽略，反之亦然。

### 方法

拜耳传感器可用的去马赛克算法如下：

- AMaZE

- AMaZE+VNG4

- RCD

- RCD+VNG4

- DCB

- DCB+VNG4

- LMMSE

- IGV

- AHD

- EAHD

- HPHD

- VNG4

- Fast

- 黑白

- 像素偏移

- 无

X-Trans传感器可用的去马赛克算法如下：

- 3-pass+fast

- 3-pass (Markesteijn)

- 1-Pass+fast

- 1-Pass (Markesteijn)

- Fast

- 黑白

- 无

#### 双重去马赛克算法

双重去马赛克方法，如AMaZE+VNG4，可以让你使用一种去马赛克方法处理高反差（即细节）区域，再用另一种方法处理低反差（即平坦，没有细节——比如天空）区域。因为某些去马赛克算法处理细节更好，有些去马赛克算法处理平坦，顺滑的区域更好，所以这些双重去马赛克算法可以让你分别获得两种算法各自的优点，这为使用其他工具进行后期提供了更好的开端，也减轻了加锐和降噪的需求。这样做的缺点是，同一张图片会被去马赛克两次，导致用时长于使用单次去马赛克算法。

你可以用*反差阈值*滑条来调整以哪个细节阈值为界，分别使用两种去马赛克算法。该滑条有自动确定最优数值的勾选框。

### 边界

去马赛克一般需要对某个像素的周边像素进行信息采样。当对于图片最上方的像素进行去马赛克时，这些像素的上方没有像素，因此它们无法按照其它周边有大量像素的像素那样来进行去马赛克，去马赛克的质量也比不上那些像素。所以大部分Raw转换器会砍掉照片周边的几行/列像素，RawTherapee默认亦是如此。但是，你可以用*边界*值来控制砍掉多少边缘像素。将它设置为“0”意味着不进行裁剪，而RawTherapee会尽其所能地对这些周边像素进行去马赛克，不过杂点是很可能会出现的！

一般情况下你应该使用默认值。“0”是不得不用的时候才可以使用的数值，比如：你在处理一张[1080P](https://zh.wikipedia.org/wiki/1080p)的DNG raw文件，而你又需要保持1920x1080个像素的输出。

### 子图像

某些Raw文件包含多张图像。当编辑这类图像时，子图像选项就会出现，它允许你编辑某张子图像，或是以某种方式合并子图像。

某些富士EXR相机在拍摄时支持“SN模式”，即“信噪比优先”模式。当编辑这种照片时，子图像组合框允许你选择“SN模式”，用平均值混合两张子图像的像素，减少噪点。

### 伪色抑制步长

设置中值滤波次数以抑制去马赛克算法所造成的杂点。伪色（斑点）可能会在去马赛克阶段，精细的细节被解析时产生。伪色抑制与色彩柔化相似。亮度通道不受此抑制功能的影响。

伪色通常在去低通滤镜相机的照片中更加常见。要注意，你选择的去马赛克算法才是决定你会遇到多严重的伪色的主要因素。某些情况下，换一个去马赛克算法比启用伪色抑制更好，因为后者会降低色彩分辨率。
