（RawTherapee教程）RawPedia译介之——小波层级

本文内容出自RawTherapee官方的文档：RawPedia（http://rawpedia.rawtherapee.com/）。具体翻译的内容是“Wavelet Levels”条目（http://rawpedia.rawtherapee.com/Wavelet_Levels）。

本文采取CC BY-SA 3.0共享协议（https://creativecommons.org/licenses/by-sa/3.0/，在进行合适的署名，引用CC版权链接，并以同样的共享协议传播内容的前提下，可以自由地复制/分发内容，详见前面的链接）。

由于本人英语和数学水平极其有限，译文仅供参考。

# 小波层级

## 目录

1 - 此工具的组织结构如何？

2 - 小波是什么？

3 - 实际使用

​    3-1 预览

​    3-2 分频反差调整 vs 小波等级

4 - 工具总体设置

​    4-1 力度

​    4-2 小波等级

​    4-3 平铺法

​    4-4 边缘表现

​    4-5 预览

​        4-5-1 背景

​        4-5-2 处理等级

​        4-5-3 使用建议

​    4-6 实例（预览）

5 - 反差模块

​    5-1 衰减曲线

​    5-2 反差等级

​    5-3 反差改变的衰减与选择

​    5-4 应用到

​        5-4-1 亮度范围

​        5-4-2 案例研究

​    5-5 实例（改变反差）

6 - 色度模块

​    6-1 整个色度范围

​    6-2 饱和/低饱和区域

​    6-3 与反差等级挂钩 

​    6-4 实例（改变色度）

7 - 色域模块

​    7-1 减少蓝天中的杂点

​    7-2 肤色

​    7-3 肤色锚定/保护

​    7-4 曲线

​    7-5 防止色偏

8- 色调模块

​    8-1 排除色彩

​    8-2 色调控制

​    8-3 实例（应用色调）

9 - 去噪与精细化模块

​    9-1 控制

​        9-1-1 与边缘锐度的强度链接

​        9-1-2 黑白去噪均衡器

​        9-1-3 去噪和力度

​        9-1-4 去噪色度

​    9-2 实例（应用去噪）

10 - 边缘锐度模块

​    10-1 设置

​    10-2 与边缘锐度的强度链接

​    10-3 局部反差

​    10-4 边缘检测

​    10-5 优化的算法

​    10-6 实例（修改降噪和边缘锐度）

11 - 模糊等级模块

12 - 加锐蒙版和清晰度模块

13 - 残差图像模块

​    13-1 残差图像的暗部/高光

​    13-2 残差图像反差压缩

​        13-2-1 压缩方法：反差

​        13-2-2 压缩方法：色调映射

​    13-3 模糊

​    13-4 残差图像的色度

​        13-4-1 天空色调

​        13-4-2 天空锚定/保护

​    13-5 残差图像曲线

​    13-6 色调和色彩平衡

14 - 最终润色模块

​    14-1 方向性反差

​        14-1-1 反差平衡法

​    14-2 最终局部反差

​    14-3 在反差曲线*之后*

15 - 最终对比

## 此工具是如何组织的？

小波层级工具是十分庞大的，其背后的算法也亦是复杂。除了插值和色彩管理以外，它有着大部分开始进行图像处理，直到最后出图所需的功能，但是，在使用RawTherapee的其他功能对图片进行处理后，这个工具在优化图像或是进行最后的调整时才是最有用的。它能让你对不同层级的细节分别进行处理，以创造细微的反差和色彩效果；去除图片的噪点/缺陷，同时不牺牲总体细节；或是处理图片的色彩和亮度，同时不造成杂点的出现。

它可以被用于任何类型的图像中，但其独特的能力使得它在人像，微距，天文摄影等需要选择性控制细节的摄影题材中大放异彩。它在风光摄影中亦表现不俗，可以移除天空中的噪点，在压缩动态范围的同时保留细节，减少噪点，移除阴影中的偏色，并创造独特的光亮效果。它的能力几乎是无限的，但你必须先理解各种工具背后的原理和操作方法才能合适地利用它们，**所以请继续读下去！**

本工具被整合在**小波设置**模块之中，下方是一系列可以被启用/关闭以完成某一具体任务的模块。

## 小波是什么？

小波，更精确的说法是小波变换，实际上是一个在图像处理中非常有用的复杂数学函数。它能让你把图像分割为不同层级的细节，让你能够处理你感兴趣的层级。

小波（Wavelet）这一术语是在1980年代早期由法国数学家让·莫莱（Jean Morlet）和阿列克斯·格罗斯曼（Alex Grossman）提出的。他们用了法语词*ondelette*，意思就是“小的波”。后来，英语接受了这个词，将“onde”改为“wave”，便有了wavelet。

小波变换和傅里叶变换相似，将数据表现为已知的，预定义的波（频率），使得处理的结果尽可能地与原数据接近。总体而言，对于二维图片来说，两者的主要区别是，在小波变换中被分析的数据表现为图像中以像素级别存在的频率，而在标准傅里叶变换中，被分析的数据表现为全图的频率。因此，使用小波变换分析数据通常会更加精准。（很明显这是个非常简单化的解释，数学家们肯定还有许多想说的……）

RawTherapee在许多工具中使用了小波，在这里它使用了多贝西小波以将图像中的元素分解为L\*a\*b\*色彩空间（L\*,a\*和b\*）的元素。

图像分解使用了一个算法来在三个方向上（横向，纵向和斜向）分析一组像素的内部反差（第一层级是2x2个像素，第二层是4x4……）。这套分析将这些反差值转化为多组振幅与强度不同的小波，并将它们的特性存储到系数矩阵中，它决定着如何重组小波以尽可能还原出与原图尽可能相近的图像。

每当你进行改变（反差，色调，噪点，……）时，这个重新生成的过程是自动完成的，这样的话你就能立刻看到你所做的调整的结果。

实际上当图像被分解的那一刻，它就不存在了，只留下了几组系数（每个层级对应一组系数）在之后用于工具之中。这些系数组可以使用以下两种方式来特征化图像：

​    多层级细节：第一层级对应着2x2区域像素的细节；第十级对应着1024x1024区域像素的“细节”。使用多少层级取决于你的需求，但是要记住，使用的层级越多，处理时间越长，内存占用越大。

由于每个层级只有只有色相和亮度的变化会被分析，那么如果图像的亮度和色彩没有变化，那么各个层级就不会有任何信息。在这种情况下，各个层级所提取出的差异均来自于数码噪点或是由边缘效果，浓雾或是其他与场景相关的光学现象所导致的反差（或色度）变化。

​    残差图像：分解整张图像中所有被分解层级中的细节后的结果。因此，在某个层级进行的任何改变（反差，色度等）对残差图像没有任何影响，反之亦然。

而且，本工具在每个层级上都会代入系数并计算其算术平均值（各个层级的平均值会有不同）和[标准差](https://zh.wikipedia.org/wiki/%E6%A8%99%E6%BA%96%E5%B7%AE)。在这些数据中添加最大和最小系数使得每个层级都生成了一条特性分布曲线（要注意这条曲线不是[正态分布曲线](https://zh.wikipedia.org/wiki/%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83)）。小波层级工具中的大量算法会以不同的方式使用这些信息。

## 实际使用

在分解后生成的各个层级可以用于不同的目的：图像压缩，降噪，秘密水印（https://www.intechopen.com/books/discrete-wavelet-transforms-algorithms-and-applications/application-of-discrete-wavelet-transform-in-watermarking），用于天文摄影的特殊残差图像处理等。

根据你的需求，你可以对单个层级的细节进行处理，或是对多层（连续的）细节进行处理，或是对残差图像进行处理，或是把上述的内容结合起来处理。

每个层级所包含的细节的大小是：

1（最精细）：2x2像素

2：4x4像素

3：8x8像素

4：16x16像素

5：32x32像素

6：64x64像素

7：128x128像素

8：256x256像素

9（最粗糙）：512x512像素

额外：1024x1024像素

### 各个层级细节大小的比较

如果你选择了5级细节，各个层级的改变都会被局限到32x32或更小的像素细节上。在这种情况下，残差图像会包含图像中各个层级的细节，除了层级1-5包括的以外。而由于被移除的细节都相对较小，残差图像会与原图相似。

而如果你选择了*9级*，你可以改变512像素大小和1024像素大小（*额外级*）的细节。在此情况下，残差图像和原像会非常不一样，因为*1*到*额外*级已经包含了所有的细节，所以剩下的就只是模糊的背景了。

小波分解会将残差图像中各个层级的亮度通道和色度通道（a*和b\*）分离。这允许你对不同层级应用不同的亮度和色彩调整，并对残差图像应用完全不同的处理操作。这意味着层级和残差图像相互独立，本工具仅修改被改变的层级。其余层级会保持原样，残差图像在细节被移除后也依然会保持不变（无论细节有没有被修改）。

要注意如果你想要同时使用小波层级工具和CIECAM工具，你可能就会让杂点产生，因为CIECAM色彩模型使用了与Lab色彩空间相近但不一样的具体数值。工具被编写的方式使得杂点无法被避免，但是它们的样子取决于具体的操作处理。

#### 预览

图像在屏幕上的大小对于锐度的感知和用户对于各种模块所造成的细微改动的认识有着直接的影响：此工具的效果仅在全尺寸大小（或更大）时可见。

在实际使用中，这意味着，出于处理速度上的考虑，你必须时刻考虑最后文件的尺寸大小。如果你打算减小图像的大小（指的是缩放，而不是裁剪），那么你最好先把图片以你想要的尺寸导出，然后用小波工具处理你导出的图片。一定记住这件事，否则你在预览中看到的图片和你导出的图片就会产生不一致。

另外一个局限是：RawTherapee使用图片预览中所有能使用的层级，并忽略掉所有大到没有出现在屏幕预览中的细节层级。但是，如果被忽略的层级的改动没有展示到屏幕上，它们也会在图片被保存到硬盘上时被应用。

**案例**

***案例1*：**图像为**4096x2160**像素，你将它放大了（100%或以上），然后在预览中，你看到了**1500x1200**大小的区域，和最终图像的大小相似。这是一个理想的情况，因为你在屏幕上可以看到对于所有层级的细节（包括*额外层级*）的改动。而且，任何层级的任何改动都会被包含在最终的图片当中。

***案例2*：**图像为**4096x2160**像素，你将它放大了，但在预览中你只看到了**300x200**大小的区域。在屏幕上，你无法看到7级（128x128像素大小）以上的细节的改动。但是，你对于*8*，*9*和*额外*级的改动会被保存到最终的图片当中（因为图片大于1024x1024像素）。

***案例3*：**图像为**720x480**像素，你将它放大到只能在预览中看到**300x200**大小的区域。在屏幕上，你无法看到7级（128x128像素大小）以上的细节的改动。在保存时，你对于*8*级（256像素大小的细节）的改动会被保存，但*9*和*额外*级的改动**不会**被保存。

为了让你时刻清楚这一信息，本工具会显示当前预览中所使用的层级数（显示在反差模块最后一个滑条的下方）。在案例2和3中，它会显示：《预览中的最大细节层级=7》.

#### 分频反差调整 vs 小波层级

值得一提的是，RawTherapee有一个叫作“分频反差调整”的工具，虽然它看上去像是小波层级工具，但是它们之间有多个重要的区别：

*分频反差调整*的层级更少（6级，相比于小波的10级）；

*分频反差调整*只允许你调整每个层级的亮度，而小波层级还允许你调整每个层级的色度；

*分频反差调整*平等地调整各个层级所存在的亮度（或色度）值，而小波层级进行的则是渐进式的调整（后文的“反差衰减”部分有更深入的解释）；

*分频反差调整*没有残差图像。

虽说如此，但是两个工具是可以一同使用的。应该注意的是，*分频反差调整*在处理流水线中被应用得更早，所以根据其调整的强度，1-6级的细节可能会受到影响。换句话说，由于*分频反差调整*的设置会改变反差，小波层级的分析可能会将图像以不同的方式分解，导致最终结果的不同。无论在什么情况下，如果你必须同时使用两个工具，那么你最好先调整*分频反差调整*，然后再调整小波层级。

### 工具总体设置

当此工具被启用时，任何调整都会影响到其下方的所有模块。

#### 力度

---

此滑条可以让你调整工具的总体力度。它和GIMP里面混合图层时使用的不透明度滑条的原理相似：所有在小波层级工具中进行的调整都可以用力度滑条混合回未经调整的原图。这允许你使用相对激进的调整，然后调整力度以获得想要的结果。

#### 小波层级

-------

此滑条允许你决定将图像分解为多少个层级。你可以选择4-9级之间的任意层级数（第10级，*额外*级，会在你启用*9*级后自动出现）。层级数越大，处理时间越长，内存占用越大。

#### 切片方法

-------

在下拉菜单中，你可以选择：

* 全图
* 切片

*全图*是更好的设置，因为它能避免多个切片的交界区域出现问题。

但是如果你的内存不足，或是你正在处理的图片太大（比如5000万像素或以上），你可以考虑使用切片：

| 所需内存大小（单位：字节），9级细节层级 |                                                                          |                     |
| -------------------- | ------------------------------------------------------------------------ | ------------------- |
|                      | Pentax K10D                                                              | Nikon D810          |
| 像素数                  | 1020万 (3888 x 2608)                                                      | 3630万 (7360 × 4912) |
| 打开图像（不使用其他工具）        | 116MiB ([[Mebibytes](https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82)]) | 414MiB              |
| 启用反差，色度或色彩保护         | 329MiB                                                                   | 1172MiB             |
| + 避免偏色               | 39MiB                                                                    | 138MiB              |
| 总计                   | 483MiB                                                                   | 1724MiB             |

### 边缘表现

--------

使用多贝西法被分解成多个组成部分的图片可以从D2（与哈尔小波分解对应）至D20之间最多选用10个系数。RawTherapee使用了*D2（低）*，*D4（标准）*，*D6（标准增强）*，*D10（中等）*和*D14（高）*这几个系数。使用的系数越大，小波就能辨识出更多的细节，不过处理时间会略微变长（通常不可察觉）。

虽然系数值和图像的质量之间并没有直接关系（取决于原图的情况），但是选择合适的系数可以让较低层级或残差图的质量更加精细：

* 某些情况下，用D2进行边缘检测的质量是最好的。
* 其他情况下，D6或D14最好。

此参数对于边缘检测和全局分解（残差图和各个层级之间的关系）的影响较大。

### 预览

----------

这些控制选项可以帮你理解如何来控制小波工具，并且在精调各个模块（比如降噪）的参数时为你提供辅助。

一共有四个下拉菜单来供你选择预览的图像。

这组选项被划分为两组主下拉菜单（其他一些下拉菜单会在你调整主下拉菜单后变为可调整状态）：

* 第一组允许你选择预览背景
* 第二组允许你选择在预览中看到哪些层级

#### 背景

在***背景***列表中你可以在三种背景中选择一种：*黑色*，*灰色*或*残差图*，当你预览任何一个或多个层级时，该选项就会被应用。

直方图会反映这些色彩选择，并允许你观察参数调整对于残差图的影响（当然，还有其他用途）。但要注意，如果你选择了黑色或灰色背景，你就将无法看到残差图（真正的背景），而你可能会觉得此时的图像看上去会有点奇怪。当你调整细节层级时尤其要注意这个问题，因为只有把背景设为残差图，你才能看到调整后的效果。虽然如此，但是有时候以中性色为背景更会让我们更清晰地看到我们所做的调整（比如降噪）都产生了什么效果。

#### 处理层级

> 本部分工具仅在RawTherapee开发者版本中可用，你可以在此下载：http://rawpedia.rawtherapee.com/Download

在**处理**列表中你可以选择：

1. 一个层级
2. 较精细的细节层级，包括当前选择的层级：**从**你所选择的层级直到*第1级*。
3. 较粗糙的细节层级，不包括选择的层级：所有层级（包括*额外*级和残差图），但你选择的层级被排除在外。
4. 所有方向的全部层级

在上一版本中，列表所展示的名称不同，但是效果相同：

1. 一个层级
2. 小于等于此层级：即现在的*较精细的细节层级，包括当前选择的层级*
3. 高于此层级：即**较粗糙的细节层级，不包括选择的层级**
4. 所有方向的全部层级

如果你选择了前三个选项中的任意一个，*处理*下方的两个下拉菜单便可供选择：

* 左边的下拉菜单允许你选择上文所述的“当前选择的层级”（从*第1级*至*第9级*，*额外级*或*残差图像*）
* 右边的菜单允许你选择小波分解的方向（*纵向*，*横向*，*斜向*，*所有方向*）

如果你选择的是*所有方向的全部层级*，你就可以直接在残差图之上编辑各个层级（*处理*下方的两个下拉菜单便不可调整）。如果你已经熟悉这个工具并喜欢看着整张图片进行编辑的话，这个选项就是有用的。另外，你需要在导出图片前选择这个选项。一定要记住：你在预览中所看到的图像就是你所导出的图像，直方图会反映图像的信息：如果你选择了*一个层级*，那么你在屏幕上就只能看到一个层级，直方图反映的也是这个层级的RGB值。当你导出图片时，最终的图像中只会包含你所选择的这一个层级。所以**在导出照片前，一定要选择*所有方向的全部层级***。

#### 使用建议

* 你可以选择*一个层级*并使用灰色背景来检视某个多贝西系数（D2到D14）对于细节的分解程度如何，然后再选择另一个系数来决定哪个系数的细节分离表现最好。
* 你可以选择*一个层级*来找到你想处理的那个层级（比如只包含皮肤缺陷，但没有皮肤纹理细节的某个层级）
* 你可以选择*一个层级*并观察改变该层级反差（或精调降噪）所产生的的效果
* 你可以选择*较粗糙的细节层级，不包括选择的层级*并选择*8*，以同时观察残差图和最粗糙的细节，并更好地体会*残差图像*模块中各个参数的调整效果
* 你可以选择*较精细的细节层级，包括当前选择的层级*和*第4级*，背景选择*残差图*，这样就能看到被修改后的最精细细节在图片中的效果，同时不会被更粗糙的细节所打扰

### 实例（预览）

---

下面是一张近乎未经处理的例图，我们将使用它来演示接下来的所有案例。在它旁边，从左到右你可以看到*第2级*细节，*第4级*细节和*残差图*。

在两个展示细节的实例中，***边缘表现***的分解系数均为*D6-标准加强*，***背景***为*灰色*。另外，为了凸显细节，***处理***选项被设为了*一个层级*。

*残差图像*是将*小波层级数*调为*5*后，移除掉所有细节生成的。

***点击放大图片***

原图：一张樱桃李花的照片，为原图的50%大小

灰色背景下的*第2级*细节：注意观察花瓣纹理的样式（你需要放大图片查看）

灰色背景下的*第4级*细节：在这一级上你看到的细节像是我们在画花的素描时会画出来的样式

*残差图像*细节：我们可以完美地看到图片各个区域的基本色彩特征

## 反差模块

在此模块中，你可以单独调整每个层级的光亮对比度（图片分解中的*L\**部分）细节。这允许你提高微小细节的对比度，营造出更锐的观感，同时又能降低较大细节的对比度。这种处理方法的一个实际用处就是，在降低总体反差（较大的细节）后，你不需要对微小细节进行太多加锐就能让图片看上去锐利。这就可以让噪点更难显现。

### 衰减曲线

---

> 本部分工具仅在RawTherapee开发者版本中可用，你可以在此下载：http://rawpedia.rawtherapee.com/Download

前文已经谈到过，小波工具会计算每个分解层级的平均数和标准差，并将这些数值应用到各个模块中。

在反差模块中，用户第一步要做的是根据自己的需求来调整各个分解层级的反差滑条数值。但是，如果你仅作出这项调整的话，反差的变化和原反差之间是成比例的（[位似变换](https://zh.wikipedia.org/wiki/%E4%BD%8D%E4%BC%BC%E5%8F%98%E6%8D%A2)，与*分频反差调整*工具的情况一样），这很容易导致杂点的生成。

为了克服这个问题，每个层级中的细节反差值会先被分析并分类，然后再被修改并以下面这一曲线的趋势被逐步衰减：

对所有反差值进行成比例改变的图表演示

大体来说，对于每个层级，这个图表展示了：

* 最低反差值在最左边，最高反差在最右边
* 用户为每个层级所设置的反差值（图表中的*反差*）定义了该层级反差值的最大变化
* 用户所设置的值在每个层级的平均反差值附近，效果达到最大（图表中的*平均*值）
* 一个反差值和平均反差值差别越大，该反差值的变化越小
* 与较低的反差值相比，较高的反差值衰减更严重

这意味着对于每个层级来说，中等反差值区域会被应用最大的变化，而两边的极端会被应用较小的改变，以避免杂点的大量出现。但我们还要注意两个重要情况：

1. 平均反差值是**每个层级中的反差值的**算术平均数：如果一个层级的反差值总体就已经很高（反差强烈），那么平均值也会很高，且该层级的极端反差会受到更小的调整
2. 每个层级都有不同的平均值，平均值取决于某个层级细节的反差值。

## 反差等级

---

此处所展示的层级的数量由***小波层级数***决定，你可以在小波设置栏中减小/提高该值。

***反差-***和***反差+***按钮能让你更轻松地渐进调整每个层级的值：第1级的调整幅度最大，越往下越小。你可以在示意图中看到，渐进调整是等差的：以没有被修改的*额外*级为起点，每个层级都比它下面的那一级高31（实际的具体数字取决于你点击***反差+***或***反差-***的次数）。

总体而言这两个按钮允许你为微反差设置一个合理的渐进性改变：前几级的调整幅度较大，后几级幅度较小。

不要忘了，如果一个层级的反差是平整的，那么调整该层级的滑条是不会有任何效果的（如果没有细节的话，就不会有任何变化）。

要注意残差图像是不包含在这组控制中的，因为它不是一个层级——它是将原图中所有层级的细节都移除后的图像。

## 反差改变的衰减与选择

> 本部分的工具仅在RawTherapee开发者版本中可用，你可以在此下载：http://rawpedia.rawtherapee.com/Download

一共有三个滑条供你调整每个层级的曲线：

1. ***衰减响应***：选择正值会让曲线的最高位的范围更加宽广，并且令权重偏向反差较高的部分。相反地，选择负值会让曲线变窄，减小变化可见的反差范围。从图像上看：（选择正的衰减响应值可以拓宽曲线。背景中的绿色曲线是滑条值为0时的原曲线。横线（反差）是一个层级通过反差滑条所能设置的最大反差值）（使用负的*衰减响应*值会让曲线变窄。背景中的绿色曲线是滑条值为0时的原曲线。如前文所述，曲线的变化在高反差的区域更明显。）
2. ***偏移量***：改变曲线顶部的位置，使最强的反差改动不再发生在中等反差部分。将曲线向右偏移会让高反差值发生更大变化，而向左偏移会让较低的反差值发生更大变化。从图像上看：（设置一个正的*偏移量*会影响到某个层级的较高反差区域（但极端反差不受影响））
3. ***低反差阈值***：在一个分解层级中，细节必须达到这个最低的反差值，才能被小波工具看作是细节。如果一个层级的较低的反差区域所具有的值小于这个最低反差值，那么在计算该层级的平均数，或是使用各个滑条调整该层级时，它们就不会被算在内。这样的话我们就可以避免调整高光噪点或是较精细的细节或纹理了。

## 应用到

---

> 本部分的工具仅在RawTherapee开发者版本中可用，你可以在此下载：http://rawpedia.rawtherapee.com/Download

此下拉选框允许你决定每个层级所做出的反差调整究竟是被应用到所有的细节之上还是应用到处于某个亮度范围的像素之上。举个例子来说，这能让你提高亮度较亮区域的精细细节的反差，并降低亮度较低区域的粗糙细节的反差。

在下拉菜单中，你可以决定将反差调整应用到哪里：整个亮度范围（即每个层级上的所有细节），或是只有具有某个亮度值的细节。

### 亮度范围

如果你选择了*整个亮度范围*，那么调整会被应用到每个层级上的所有细节。但是如果你选择*特定亮度范围*，你就可以决定修改哪个层级的哪些细节。

另外，在选择*特定亮度范围*后，两个阈值曲线和两个滑条会出现，让你调整结果，即：

- **较精细层级亮度范围：**
  - 此区域有着一个黑白渐变色条，上面有四个滑块供你确定反差调整所将影响的亮度范围。
  - 如果你将鼠标移到其上，你会看到默认的限制区域是：*左下：50，左上：75，右上：98，右下：100*。这个范围覆盖了高光区域。
  - 只有满足上述亮度范围的细节才会受到反差调整（见下文的滑块解释）
  - 默认值的意思如下：
    - 亮度低于等于50的细节不会被改变
    - 亮度在50-75之间的细节会随着亮度的提升，受到越来越强的调整
    - 在75-98之间，调整力度为100%
    - 在98-100之间，力度会逐渐下降
  - 我们有两个方法来改变曲线的点
    - 点击并移动左右两边的一个点，然后你会同时拖移这一边的两个点
    - 按住*shift*键，点击一个点，你会只移动一个点
  - 默认值专门针对了高光区域，但你可以根据自己的需要，让这些点覆盖阴影到高光区间的任何一个部分。
- **较精细层级：**只有选中的层级和比其更低的层级会被*较精细层级亮度范围*阈值曲线影响。
- **较粗糙层级亮度范围：**
  - 此区域也有一个黑白渐变色条，上面有四个滑块供你确定反差调整所将影响的亮度范围。
  - 如果你将鼠标移到其上，你也会看到默认的限制区域是在阴影附近：*左下：0，左上：2，右上：25，右下：50*
  - 默认值的意思如下：
    - 亮度在0-2之间的细节会随着亮度的提升，受到越来越强的调整
    - 在2-25之间，调整力度为100%
    - 在25-50之间，力度会逐渐下降
    - 50以后的细节不会被改变
  - 默认值专门针对了阴影区域，但你可以根据自己的需要，让这些点覆盖阴影到高光区间的任何一个部分。
- **较粗糙层级：**选中的层级到*小波层级数*所设置的最大层级都会被*较粗糙层级亮度范围*阈值曲线影响。

*较精细层级*和*较粗糙层级*都没有覆盖到的层级不会被调整，不论你为该层级设置的反差滑条值为多少。对于这些层级而言，最后的结果与把该层级的反差滑条值设为1是相同的。

### 案例研究

+ 你设置使用7个层级且只想改变第7级中，满足你所设置的*较粗糙层级亮度范围*阈值曲线的亮度范围：将*较粗糙层级*滑条设为7（译注：这句话的意思是：*较粗糙层级亮度范围*本身指定了一段亮度范围，但是没有指定调整哪个（些）层级。所以需要将*较粗糙层级*滑条设为你想调整的层级，这样，被你指定的层级和亮度范围就会得到调整。）
+ 你设置使用7个层级且只想调整最精细的细节：将*较精细层级*滑条设为你想调节的最高层级，并将其余层级的反差滑条设为0
+ 你设置使用7个层级且想根据*较精细层级亮度范围*滑条的亮度范围调整第1和第2级，并根据*较粗糙层级亮度范围*滑条的亮度范围调整第6和第7级：将*较精细层级*滑条设为2，*较粗糙层级*滑条设为6。这会选择性地改变第1，2和第6，7级（亮度范围由两个亮度范围滑条分别控制），第3，4，5级的细节不会被调整。

### 实例（改变反差）

下面是一张例图，其旁边的照片，自上向下是（点击15次**反差+**按钮后，）将反差调整应用到所有层级后的几种不同情况。

首先是**整个亮度范围**的效果，下面是使用**选定亮度范围**的效果，最后是使用**力度**滑条来精调效果的一个实例。

没有明确提到过的滑条都处在默认值（滑块则是在默认位置）上。

*原图*

*将效果应用到**整个亮度范围**：背景噪点很明显地更容易看清了。*

*将效果应用到**选定亮度范围**：**较精细层级**为3，**较粗糙层级**为6：效果更好了，但还是有点过头。*

*效果同上，但是工具的**力度**降低到了50。*

现在同时对比一下原图和最终图像，方便更清楚地看到区别：你可以看到画板纹理的锐度提升，图片的整体效果又没有被破坏。

## 色度模块

此模块与反差模块使用方式相似，不过在这里，此工具分析的是色彩反差（a\*和b\*通道）。

在**色度方法**下拉菜单中有以下选项：

+ 应用到整个色度范围：使用该选项，任何层级的任何改变都会影响所有的色度范围，不论*反差模块*中的层级值是如何设置的。
+ 与反差模块挂钩：色度的变化会直接与*反差模块*中每个层级的值产生关联。
+ 根据饱和度高低：在这里你可以调整两条同时生效且限制饱和/低饱和色调的阈值曲线，*反差模块*的值不被考虑在内。

当你选择应用到整个色度范围或根据饱和度高低时，你可以使用还原按钮将所有的层级滑条重置为默认值（0）。
此外，所有3个选项都有一个衰减响应滑条，它的作用与本文对比度模块的衰减所述的部分相同。

### 应用到整个色度范围

如果你选择了这个选项，图像中的全部色度范围都会被改变，不管每种颜色的饱和度如何。
反差部分的观察结论也适用于此：要想有颜色的变化，色阶中必须预存颜色间差异。如果一个层级的颜色是统一的，滑条就不会产生任何效果。
每个层级的修改被限制在[-100,+100]的范围内：-100相当给一个层级完全去饱和，而+100则是增加每层细节的色度。这种方法几乎总是引入伪色，因为应用于每个细节的颜色值的公式没有考虑到是否有任何偏离初始值的情况。

修改了反差的图片，小波工具的总体力度为100%
效果作用于整个色度范围，5个层级的滑条值为100：即使在降采样的图片中你也能看到彩色杂点（这是可以预料到的，因为工具的效果被最大化了）
在第1级和第2级上应用最大效果之后：在这个大小上几乎没有任何变化（要记得我们修改的是最精细的细节）
放大400%后的细节（比前面的图片大8倍）：在顶部，应用了颜色修改后可以看到杂点痕迹，特别是在花蕊的边缘，但花瓣的纹理几乎没有任何变化

上面的例子意味着你应该只用这个选项做细微的改变，因为根据改变的层级和力度，引入非常可见的杂点是很容易的。但是，如果变化太细微，就很难被明显看到。在所有情况下，色度噪声都会受到影响且明显增加。

### 根据饱和度高低

如果你选择了这个选项，每个层级的色彩变化会集中在较精细层级的饱和色彩与其它层级（较粗糙细节）的低饱和色彩上。
选择这个选项后，会出现一个阈值滑条和两个阈值曲线，操控方式与上文的反差阈值曲线相同。

+ **饱和色/低饱和色阈值**
  + 此选项能够让你控制令哪个层级成为饱和/低饱和的分界点
  + 默认值为5，即前5级中的饱和色彩会被改变，更高层级的低饱和色调会被改变
  + 要注意如果这个值比小波分解层级数更高的话，那么只有饱和色彩会被改变
  + 而如果你选择了*1*（只有最精细的细节的层级），那么效果几乎就是只有低饱和色彩会被影响
+ **低饱和色度范围**
  + 阈值曲线和反差模块中的一样。四个点定义了色度变化有效的饱和度区间
  + *要注意轴的黑色部分代表低饱和区域，白色部分代表饱和区域（根据这个对于饱和度的解释（https://en.wikipedia.org/wiki/Colorfulness））*
  + 将鼠标移到它上面，你可以看到它的限制范围：默认为：左下：0，左上：2，右上：20，右下：30
  + 曲线的变化方式与反差曲线相似
+ **饱和色度范围**
  + 将鼠标移到它上面，你可以看到它的限制范围：默认为：左下：30，左上：45，右上：100，右下：130
  + 虽然两条曲线的值没有交集，但是你可以在曲线轴上看到相交。在现实中改变阈值会同时影响饱和/低饱和色调。为了能看清效果究竟存不存在（取决于色调是饱和的还是低饱和的），你需要使用非常饱和/低饱和的数值

抛开这些不谈，与*整个色度范围*选项一样，色彩的变化是不明显的，除非你愿意引入一些比较明显的色彩杂点。

修改了反差的图片，小波工具的总体力度为100%
将最大效果应用于第1和第2级
将效果分别应用到饱和和低饱和色调。***饱和/低饱和阈值*** 为第3级。最大效果在第1和第2级，第3级为60，其它层级为0。
放大400%后的细节（比前面的图片大8倍）：在顶部，应用了颜色修改后可以看到杂点痕迹，特别是在花蕊的边缘，但花瓣的纹理几乎没有任何变化
另一张修改反差，小波工具的总体力度为100%的图片（与饱和/低饱和色调变化过的图片对比）

如你所见，尽管在某些层级上应用了100%的变化，但差异是细微的，如果你不仔细看，看起来可能无法分辨。最明显的变化是花瓣中颜色更浓的“叶脉”。

### 与反差等级挂钩

这个选项很有意思，因为色度的变化与每个反差等级的变化产生了关系。

反差和色彩变化之间的比例是通过 ***色度-反差挂钩强度*** 滑条来调整的：因此0将对色度没有影响，而100将提供最大的效果，并且在选择 ***整个色度范围*** 选项后更加强烈（尤其在色度噪点中特别明显）。

请记住，如果你对反差等级进行强烈的调整，变化也会反映在色度上，并且很可能会产生不想要的杂点：你最好的队友是 ***色度-反差挂钩强度*** 控制，以助你实现清晰可见的效果，但又不会产生会毁掉照片的杂点。

### 实例（改变色度）

对原始图片的修改被夸张化了，以使结果清晰可见。因此，对最后一张照片所做的反差和颜色修改在花瓣上引入了蓝色的边缘，花蕊的花药周围出现了光晕，背景也有噪点。尽管如此，考虑到修改的激进性，这张图并不完全是场灾难。此时值得注意的是花瓣“脉络”中的颜色强度。

## 色彩范围模块

此模块与反差和色度模块挂钩，以令该模块的调整能够成为色度细节的函数。换句话说，对于每个小波层级中的细节，你不仅可以根据亮度反差（由反差模块控制）或是色彩反差（由色度模块控制）来进行调整，还可以选择哪些颜色范围会受到调整。

### 减少蓝天中的杂点

数码相机照片中的蓝天经常会有斑驳的噪点。小波处理可能会增强噪点或生成小杂点，因为它能增强局部反差。

此选项框会使用一个中值滤波器来减轻这些杂点，不过代价是细节会有损失，且在色调变化较为急剧，以及高反差区域会出现新的杂点。虽然这个工具对于快速且要求不高的后期处理来说够用，但是仔细地调整细节栏的*降噪*工具，以及高级栏的去噪与精细化参数可以令你获得更好的成果。

原图，蓝天有杂点

使用*减少蓝天中的杂点*所生成的杂点：在线条交界处你可以看到更多细节，并且细线的反差降低了。

### 肤色

虽然这个工具名叫肤色，但是它能控制的不仅只有肤色，你可以用它来控制你所想要的任何颜色。只有被此工具所选中的色彩范围才会受到其他小波模块的调整，只不过默认被选中的色彩范围是通常意义上的肤色而已。

在下图的实例中，只有（比较局限的）红色色调被选中了。

### 肤色针对/保护

此项允许你改变对于肤色工具所选中的色彩范围的反差/色彩修改。

+ 滑条为0，图像中所有色彩被平等调整
+ -100（滑条拉到最左边）会让反差与色彩调整仅被应用于**所选的色彩范围**
+ 相反，如果滑条值为100，那么只有被选中的区域**不会**被修改

如果使用0到±100之间的值，那么调整就会相对偏向于所选范围或是未选范围。

### 曲线

当你设置好肤色针对/保护后，你便可以使用此工具来精调每个色彩的反差/色度变动：将控制点向上移会增加色彩的变化，向下移会减弱你对一个颜色所做的调整（不过你无法完全移除对一个颜色的调整）。

然而，只有被上述工具所选中的色彩才会被调整，不论你用曲线调整了什么颜色。

### 避免偏色

使用小波处理图像可能会导致明显的色相改变，尤其是那些接近工作色彩空间的颜色。启用此选项会进行一系列矫正，令最终色彩与一开始的色彩保持关联。

#### 调色模块

此模块可以用来对某个层级进行色调映射。

但是它无法对每个层级的色相进行直接而准确的控制，因为a*和b*通道已经被分解，所以很难在数学上确立所选色相与分解部分之间的关系。

当然，你还是可以在一定程度上控制要改变哪个色相并决定它们向哪个主色偏移。

和其他模块一样，它也有一个*衰减响应*滑条，它与前文介绍的反差模块的衰减响应原理一样。

### 被排除色彩

**被排除色彩**表是基于L\*a\*b\*色彩空间的色彩分布坐标系的：横轴是a\*通道（由绿向红），纵轴是b\*通道（由黄向蓝）。

然而，由于以二维方式表现L\*a\*b\*色彩空间的色彩分布比较难办，软件界面中的色彩看上去饱和度比较低，但实际上是在数学上准确的，不过看上去可能就不够直观了，尤其是黄色部分。从感官体验来看，颜色表看上去更应该是这样：

颜色表的中心是一个白点，如果拖动它就会出现另一个黑点。这两个点会决定在接下来的色调调整中，哪些色彩以及周边范围会被保护。将白点放在某个色彩上将决定第一个色彩范围，而黑点决定着第二个色彩范围。如果黑点呆在中心没有移动，那么就不会存在第二个色彩范围。

***a和b范围*** 滑条的数值决定着以两个点为中心的保护色范围有多大。

***保护*** 滑条会令保护色范围中的色彩（中心+周边）所受到的调整减弱。保护滑条的值就是保护的百分比力度，但周边的色彩所受的保护力度会逐渐降低，最边缘色彩的保护力度会是中心力度（也是保护滑条的值）的一半。

举个例子：保护=80意味着保护力度是80%，也就是说每个保护范围的中心只会受到均衡器模块（在下文中会介绍）的20%的调整。而当我们开始远离中心，向*a和b范围*所设置的边缘观察时，调整的力度会不断加大，直到保护值衰减到一半，也就是40，也就意味着对于最边缘色彩的调整力度是60。

#### 调色控制

在该组控制中，共有两条曲线：

+ ***红-绿不透明度***（*a*\**曲线*)，作用在红-绿色调上
+ ***蓝-黄不透明度***（*b*\**曲线*)，作用在蓝-黄色调上

但不要忘了，图片的最终色彩将是由这两条曲线所共同混合出的色彩。举个例子：如果你调整了a\*曲线（***红-绿不透明度***），那么所有被你调整的色调都会偏向红色，但不一定会变成红色（如果色调本身偏蓝的话，那么调整后实际上会偏紫）。

从实际角度而言来解释就是：一个色调在*一定范围内*可以发生饱和度的变化，而同时其色相也会发生改变。若要更清楚地看到此现象，你可以参考此图，图中的纵轴是b\*通道，横轴为a\*通道。顺便还可以再看一下这张L\*a\*b\*色彩空间的主视图。俯视图的下方对应着主视图的前方。

界面有两种曲线模式：线性和均衡器。点击右边的倒三角以选择一种曲线类型。

线性曲线会取消对应色调上的调整：如果你将 ***红-绿不透明度*** 曲线的模式选为线性，那么红-绿不透明度将不会受到调整。蓝-黄不透明度亦是如此。

在均衡器曲线中，会有两个轴向：横轴（X轴）与纵轴（Y轴）。

- X轴表示着十个层级，从左到右递增，且均匀分布在X轴上。

- Y轴代表着调整的力度：当曲线移至纵向中轴的上方或下方时，色彩便会偏向L\*a\*b\*色彩空间的对应色彩通道（即a\*或b\*通道）。

- 在 ***红-绿不透明度***（a\*曲线)中，将曲线向上移动会令色彩偏红，向下移动则会偏绿。

- 在 ***蓝-黄不透明度***（b*曲线)中，将曲线向上移动会令色彩偏黄，向下移动则会偏蓝。

均衡器曲线默认是一条沿纵向中轴水平的直线。如想了解如何调整曲线，请参考色调曲线一文。不要忘了，如果你不喜欢你所做的调整，可以点击曲线右上方的箭头将曲线重置为默认状态。

只要原图在色彩上有反差上的层次，这些曲线便能让你有选择性地调整某个细节层级的色调。调整的结果取决于你将调整点所放置的地方，以及曲线的起伏幅度（即：曲线所影响的细节范围）。一切调整只能依靠眼睛，因为X轴所代表的细节层级是无法直接看到的，但是你所做的调整可以在预览中直接看到。

如果你选择的层级数小于10，则曲线最右边的调整会被直接忽略。如果你调整的图片只有4个层级，那么针对右边6个层级（较粗糙细节）的调整将被忽略。

#### 实例（应用调色）

你可能会想起来，之前花的边缘有一些不好看的蓝色光晕，所以让我们试着用调色工具去掉（或者说是隐藏）它们。这张图片的主色调是红色，所以很幸运，我们调整蓝-黄色不会太多地影响图片。在这张图片中，我们没有排除任何颜色：

（在色度模块中调整过的图片，总体力度为50%）

（通过在蓝-黄曲线上使用最极端的调整，你可以看到之前有蓝色光晕的地方现在出现了黄色光晕）

（所使用的曲线，主要影响了第3级和第4级，第5级也略受影响）

（对曲线进行较为适中的调整，以尽可能消除蓝色光晕）

（与上张图同样的调整，小波总体力度设为50%）

（所使用的曲线，影响的层级与之前大致相同，但是力度更低）

图片最终仍然残存一些蓝边，虽然没有那么明显了。图片总体的观感基本上也没有太大变化。

### 去噪和精细化

此模块是对于降噪工具（位于*细节*栏）以及边缘瑞都（将在下一节详细说明）的补足。

噪点控制是个复杂的问题，因为降噪的时机（即在后期流水线的哪个位置，究竟是开头还是结尾，进行降噪），方法和算法都需要审慎决定。

在RawTherapee中，降噪工具被放置在后期流水线的起点以避免位于流水线后端的工具将噪点放大到不可接受的地步。细节栏的*降噪*工具允许你实现以下功能：

+ 成块处理亮度噪点（此功能同样基于小波），即不区分各个小波层级。

+ 使用另一种方法处理色度噪点：这通常需要较高的小波层级数（4至7级）以及更加复杂的处理。

+ 添加*傅立叶变换*操作以改善亮度噪点。

+ 添加中值滤波器。

虽然这些功能可能已经足够用了，但使用小波层级功能可以带来一些额外的好处（虽然它和普通的降噪工具使用的是同一套算法）：

+ 小波降噪位于后期流水线的最后，因此可以去除由其他工具引入的噪点（如*曝光*，*曲线*，*动态范围压缩*等）。

+ 它可以单独调节前4级的降噪，而普通的降噪工具会作用于整张图像。这对于噪点较少或是一些如果要保存，降噪力度就必须降低的图片尤为有益（即用户可以精细地减少噪点，又不至于消灭所有噪点）。

+ 它能减少由于其他小波模块带来的噪点，比如，它能让你在处理天空的同时避免放大噪点。

+ 它既能降噪，同时又能控制各个层级反差的增强／削弱， 在天文摄影等题材有实用性。

#### 控制方法

你可以用下列调整选项控制各个层级的降噪，它们不仅能决定要处理哪些噪点，也能将降噪与*边缘锐度*以及色度降噪挂钩。

##### 与边缘反差的力度挂钩

此选项可以调整每个层级下边滑块的效果（下面将作详解）。

+ 如果你不启用此选项，则每个层级下边的滑块（**力度**滑块）的效果和反差模块（*作用于整个亮度范围*）的滑条相似。

+ 如果启用选项，你可以控制较低层级的锐度强化分布比例（此效果将在下个模块，*边缘锐度*中作更详细的解释）。

##### 去噪均衡器黑白

人类视觉更容易看出明亮区域的噪点（而非较暗区域的），即使在暗部（阴影部分）噪点多于亮部噪点时也是如此。

此滑条可以提升阴影（向右拖动滑块）或高光（向左拖动滑块）的降噪力度。

在处理时，你可以选择一片既有明亮区域，又有阴影的地方进行放大，以便观察亮部与暗部的噪点情况。

##### 去噪与力度

这些滑块用于控制较精细的四个层级的噪点：

+ 每层级上方的滑块控制**去噪**。

+ 下方的滑块被称作**力度**滑块，它控制每个层级的细节反差。需要注意这里的滑块在功能性上不如反差模块中的滑条所提供的控制精细。

这些**力度**滑块看上去是功能重复的，但是在降噪力度较强时，它们能快速让你恢复细节反差，而不必在反差模块与去噪模块之间来回切换。它也能控制前4个层级的*边缘锐度*效果分布。

##### 色度去噪

色度去噪是对细节栏降噪工具的补充。

由于小波色度降噪处于后期流水线的最后，它可以用来去除没有被细节栏降噪工具所移除的色度噪点，或是其他工具引入的色度噪点。

在这组滑条中你可以看到：

+ **去噪均衡器蓝-红**：色度噪点一般为红色或蓝色的点，你可以控制此滑条来增强对于蓝色色噪（向左滑动）或是红色色噪（向右滑动）的去除力度。

+ **精细色度**滑条：降低精细层级（即最低的几个层级）中的色度噪点。

+ **粗糙色度**滑条：降低较粗糙层级（即较高的几个层级）中的色度噪点。这类色度噪点表现为比较“脏”，或是看上去“不属于整张图片”，而又无法被精细色度滑条移除的色斑。

##### 实例（应用降噪）

为了更好地看到哪些地方可以进行降噪，一个有效的做法是利用单独查看某个层级中的细节的功能（在预览的段落中已经介绍过），一级一级地进行操作。关闭与*边缘锐度的力度挂钩*选项，将你要处理的层级的力度滑块拉满：噪点在此时会非常明显，方便你确定该进行多少降噪。当你调整完去噪滑块后，再将这个层级的力度滑块拖移到一个你觉得合适的数值（拖移到负值也是可以的），然后就可以进行下一个层级的调整了。

一般来说，最好不要去掉所有噪点，把噪点减少到勉强能看见的程度就可以了，然后再在此基础上提高这个层级的反差。放大一个层级的细节可以让观众在观看图片时忽略掉噪点，并且让图片有一定的细节质感。降噪的操作流程如下：

1. 使用细节栏的降噪工具略微减轻亮度噪点，注意不要让细节产生丢失；

2. 选择观察*一个层级*，*灰色背景*以及*第1级*；

3. 找到一片几乎没有焦外细节的区域并放大300%-400%（被放大的区域必须要有足够多的细节，但也不能多到分不清细节和噪点）；

4. 将*第1级*的*力度*滑块拉满（或是接近拉满），确保你仍然能分清细节和噪点；

5. 调整第1级上方的滑块，直到噪点被降低到中低水平（不要把噪点全部去掉），然后将下方的力度滑块还原到初始位置；

6. 刚才的降噪会导致细节中的反差降低。为了对其进行弥补，我们将力度滑块向右拖移，以将该层级恢复到起初的细节反差水平；

7. 将观察选项调整为第2级，重复第4，5，6步，不过这次是调整第2级的力度；

8. 对第3级和第4级做同样的操作；

9. 将观察选项设为*所有方向的全部层级*，降噪结束。

如果图片中的噪点不多，你可以直接从第二步开始。但如果图片中的噪点很多，那么第一步的亮度降噪就非常有必要了：你需要调整降噪工具里的*亮度*降噪滑条，并调整*伽马*滑条让降噪偏向较亮或较暗的区域。你在这步做得越认真，最后的结果就越好。

你可以用每个层级下面的力度滑块来增强细节表现到你想要的程度，但要追求最好的效果，最好还是用*反差*模块来进行控制，因为那里的控制选项更多，能让调整的效果更好，杂点更少。还有，在这里我们只使用了去噪和力度滑块，但如果有需要的话，你其实可以再用模块内的其他滑条来优化结果。

不要把这个模块里的去噪功能与*边缘锐度*模块中**边缘检测**的**阈值低（噪点**）搞混了，那个功能的作用是将噪点纳入边缘检测算法的考量之中（不进行降噪），以避免将噪点当作边缘进行强化。

### 边缘锐度模块

此模块会对各个小波层级中的细节进行轮廓检测。

打眼一看它可能很像非锐化掩模（Unsharp Mask），因为将小波的各个层级分解后会得到一张像是掩模的残差图，但二者的相似点到此就结束了。

如果你想用此模块实现类似于USM锐化或是反卷积的效果，那么你就需要勾选*边缘检测*选项框并使用较高的*渐变敏感度*值（大于70，默认为90）。最好不要使用*分频反差调整*来调整较低的几个层级，因为这样做会干扰算法的正常工作（所有的选项将在下文进行解释）。

在解释此模块的使用方法前，读者需要清楚以下两个选项的设置，以避免大量杂点的生成：一个是使用合理的*边缘表现（D2, D4 ... D14）\\*系数设置，另一个是（启用了与边缘锐度的力度挂钩的）每个层级去噪与精细化的力度，它对边缘检测有明显的影响。每当你进行调整后，你都需要对图片进行评估，重新调整各项参数以得到良好的锐度以及最少的杂点。

界面中有多个控制分区：

+ ***设置***：第一个分区允许你调整本工具检测边缘的方法。

+ ***局部反差***：此分区允许你根据细节起初的对比度决定其受到的反差调整。

+ ***边缘检测***：对最需要加锐的区域（即边缘）提供锐化。

##### 设置选项

***现在先不要启用边缘检测选项，因为启用此选项会造成最终效果变化。***

一共有四个滑条：

1. **力度**：细节所受到的反差增强的数量。力度的值越高，反差变化就越大。其效果在较低的层级更加强烈，将滑条重置到默认值会令此模块所做的其他调整无效。

2. **衰减响应**：它与我们之前在反差模块中提到的衰减控制工具相同。它控制反差值被改变的程度。

3. **半径**：创造3D的图像效果，且可能让细节显得更多，或是纹理更加清晰，并且在数值为0时也有效果。还需要注意的是，*半径*的效果是由*细节*的数值决定的。

4. **细节**：改变各层级细节的分布。如果将指针移向右边，效果就会偏向前3级，而如果向左移动（偏向负值），那么前3级的调整会被几乎抵消。

下面的例子将带领你了解每个层级的反差变化与*半径*和*细节*滑条的值有多么相近的关系，以及*半径*值的效果如何随着*细节*值的调整而变化。为了进行演示，我们将第1级设为不变（接下来会解释为什么这么做）并且禁用*去噪与精细化*模块的*与边缘反差的力度挂钩*。

+ **半径-反差比**：改变*半径*值会令细节的反差被调整。总体而言，在半径值处于40-75的区间时，反差的变化最强烈。半径低于40时，第1级会被强化，半径时高于75时，第3级会被增强（更高的层级也是如此，但幅度更小。调整的层级越高，最后的效果就越软。调整到第9以及*额外*级时，效果已经可以忽略不计了）。

+ **半径-细节关系**：取决于*细节*的值，调整*半径*会多多少少地提升某个层级的细节反差。

以下是对上方重点的总结。图像内容是为了让读者更易理解：

+ 在**细节**为**\-50**时，前3级的反差变化随*半径*值增加的变化情况。在此情况下，除了在*半径*为*60*时，反差几乎没有变化。但是第4级及更高层级的反差值更高。

+ **细节**为**10**（默认值）且半径值低于40时，第1级的强化幅度最大，而在75以上时就远没有那么强的幅度了。随着半径的增加，第4级及以上的反差仅受中等幅度的增强。

+ 当你选择细节为100时，第2级在各个区间几乎都有最显著的调整效果。在此*细节*值之下，第4级及以上的反差随着*半径*的增加虽有增强，但并不明显。

在细节的控制项下，**第1级**有三个下拉选项：

+ *强化*：第1级的效果提升。

+ *不变*：算法按照原样运作。

+ *减少*：对第1级的调整幅度减小。

这三个选项的效果取决于图片中精细细节的数量，细节之间有多少反差，以及分解系数（*D2, D4......D16*）的选择：在有高光光源（比如路灯）的夜景图中，*减少*选项可以柔化第1级的所有高反差噪点。但大部分情况下，第1级的细节都是可以忽略的，所以这个选项的选择可能并不重要。

还有，如果你选择使用*减少*选项，你可能会发现*第1级*的表现会有些奇怪，或者至少显得“不同寻常”：当*半径*为*0*时，反差最大，然后随着半径的增加，反差会越来越小，直到*半径*为*19*时细节几乎全糊，接着在*半径*为*20*时重回前高，然后在20-100的区间内逐渐下降。用图像来看：

随着半径增加，第1-3级的反差变化。看第1级的变化，尤其是在*半径20*附近的情况。**第一级**选项为**减少**。

最优的选项是*不变*，因为你可以使用更加线性可控的*与边缘反差的力度挂钩*选项。

##### 与边缘反差的力度挂钩

以上段落是以未启用*与边缘反差的力度挂钩*（位于*去噪和精细化*模块）为前提的。不启用该选项意味着反差变化完全取决于*半径*与*细节*的值。

但是，如果你启用*与边缘反差的力度挂钩*选项，每个层级的降噪力度设置将会决定边缘反差中前四级的效果力度。这能让你调整某几个特定层级，并且将锐度提高到使用10个*反差*滑条所无法达到的程度。

举个例子，你可以：

+ 让*第1级*的反差不变

+ 提高*第2级*的最大力度

+ 降低*第4级*的反差（将*力度*设为负值）

##### 局部反差

此工具会计算每个分解层级内部的细节反差（又称作*局部反差*）的均值与标准方差值，然后将计算的结果用于接下来的操作。

要知道所谓的“细节”实际上是图片中的一组像素。小波层级越高，这个像素组的面积就越大（第1级的每组细节由2x2=4个像素组成，第2级是4x4=16个像素，以此类推）。由于每个像素与该组细节中其他像素的初始亮度都不同，这个工具便可以得到并分析像素之间的反差。

所以举例来说，你可以：

+ 对于较低的初始反差值域（一般是在阴影部分）：降低局部反差以柔化细节

+ 对于处于平均水平的值域：通过提高局部反差来改善它们

+ 对于高的值域（一般在极亮的高光）：降低（甚至可以完全移除）局部反差，以避免高光*溢出*

你可以选择用两种图形界面来设置此参数：

1. 一条有四个可控点的阈值曲线，从左到右，四个点分别代表最低反差，平均值，平均+标准差，以及最大反差

2. 一条曲线，默认是一条非对称高斯型曲线，其特征如下：
   
   + 横轴的中央对应着反差值域的平均值
   
   + 中央向左/右延伸三分之一的区域处在标准差的数值范围内

###### 使用滑块的曲线

如果你选用阈值曲线，将一个点向右移动会增加反差，向左移动则会减小反差（轴的白色部分代表高反差，黑色代表低反差）。

如之前所述，四个点从左到右分别对应着最低反差，平均值，平均值+标准差，以及最大反差。举个例子，将代表平均反差值域的点向右移动会提高接近平均反差区域的反差值。其他的点也是类似，也就是说这个工具会根据调整点的位置，对各组反差值域（平均值，平均值+标准差，最小，最大）作出调整。

在实际使用中：

- 对阈值曲线上的各点使用默认值，图像通常会看上去比较自然，但代价是较亮的部分，尤其是高光部分，会变得更亮。不过细节会被更加自然地强化，比使用高斯曲线更加清晰，并且不会过度放大噪点。

- 在日光照片中，由于图片的基调以中间调为主（如城市风光），默认值可以增强细节而不放大反差（但是反射光会更加强烈）。

- 但在高反差的图片中（有人工光的夜景，星空摄影等），默认值通常会过度提亮亮点。

- 在高反差且反差噪点很多的图片中：选择*削弱第一级*，那么第1级的效果会被减弱，噪点会很平滑。但是，如果图片的对比度不高，那么这个选项就不会有什么效果。

###### 高斯曲线

在这里，曲线的形状是你在改变细节反差值时的视觉参考。别忘了，反差值的标准差是在图表的前后三分之一部分。

与阈值曲线相比，此图表不仅能让你选择修改哪些部分的局部反差，还能让你选择修改的力度： 将一个点向左右调动会影响修改范围的大小（就像滑块点一样），向上下滑动会修改细节调整的力度。

阈值曲线和高斯曲线的默认值会带来不同的效果，所以选择哪种曲线取决于你所想达成的目的。不过，在使用高斯曲线时，尽量将力度设为一个比较小的数，以避免工具的效果被过度放大。使用阈值曲线能让你在保持高力度值的同时实现*自然*的效果。但其实使用高斯曲线也能做到，而且你还能自由提升或降低某个区域的反差，甚至把曲线的纵轴拉到最低，完全去除反差。

###### 边缘检测

在使用此工具之前，你需要仔细调整上述参数，尤其是局部反差。你应当将变化幅度控制得较小，因为后续步骤很容易放大之前的效果以及噪点。

边缘检测的效果不同于传统算法（USM锐化，反卷积......），因为它会对各个层级上的细节进行一系列操作，以凸显边缘并保持噪点不显得突出：它会强化分解图的细节，令其模糊以移除噪点，然后选中被看作是边缘细节的部分。

此过程基于Sobel-Canny算法，算法有部分修改以适应分解图的组成部分并将所有必需的变量分成了三个滑条：

+ **渐变敏感度**：将此滑条向右移动会让检测算法更加倾向于较大的细节，并逐渐忽略较小区域（如噪点或小的细节）的局部反差。反之，将滑条向左移动，算法会检测出更多的边缘，即使是最小的细节，但是这样也会让噪点更突出。

+ **阈值低（噪点）**：此滑条会设置一个不会直接影响图片的高斯过滤器，它实际上是一个分解系数。拉到左边，它会作用在3x3矩阵上，而拉到右边，它会作用在5x5矩阵上。图像被模糊之后，噪点，较精细的以及较低反差的细节会被削弱甚至消失。因此它有利于消除噪点，但同时也会导致边缘检测的准确度下降。滑块越向右，噪点消除力度越大，但是能被检测到的边缘也会变少。3x3左右的数值适合用于检测较精细的细节，但更容易受到噪点的干扰。5x5更适合用于检测较宽或较明显的边缘，代价是较精细的边缘不会被检出，导致检测精度下降。

并且，在算法的靠后部分中，这个阈值还会尝试移除虽然被检测判断为边缘，但又不太可能是边缘的区域。这个阈值越低，它就越能够检测到低反差边缘，但也更容易将噪点看作是可能的边缘。

+ **阈值高（检测）**：当图像中的边缘被检测到后，此滑条允许工具对边缘检测的可靠性进行分析（即一个边缘究竟算是锐利的还是模糊的边缘）然后根据边缘的锐度增加或衰减其局部反差。将滑条向右移动将增加锐利边缘的反差，向左移动将会令其衰减。

###### 增强算法

启用此部分模块能够让你对边缘检测算法的某些方面进行设置：

+ 边缘敏感度：此数值允许你抛弃反差值低于该值的细节。滑条越向右滑动，能被检测为是边缘的边缘所需的反差就越大（反差低的边缘会被忽略）。

+ 放大基数：此滑条会强化计算开始前的初始值以改善边缘检测。越向右拉动，边缘和非边缘的界限越清晰，但出现噪点的可能性也越高。

+ 临近像素：你可以在此处决定细节周边的像素对边缘检测的影响程度。你可以选择三个选项：*无*，*低*，*高*。

###### 实例（调整降噪和边缘锐度）

##### 模糊层级模块

此模块允许你有选择性地让所选中的层级的细节模糊化（“失焦”）。其效果在较高层级中更加明显（第7级及以上），并且在天文摄影中非常有用。

***衰减响应*** 滑块的效果如反差模块中的衰减所介绍。

***根据层级进行模糊*** 曲线会调整各层级的亮度：它一共被分成10个区，左边是第1级，最右边是额外级。将某个层级所对应的部分在曲线中拉高会提高该层级的模糊程度。

色度模糊滑条会把色彩和他们的周围混合在一起，制造出轻微的发脏感。它作用在之前曲线所影响的层级上。

##### 锐化蒙版和清晰度模块

*锐化蒙版*功能是RawTherapee中的一种新式的锐度增强方式（相对*USM锐化*，*反卷积*和*小波层级边缘锐度*而言）。它可以与这些工具联合使用，也可以单独使用。

USM锐化是一种传统上用来凸显边缘，强化图像中细节的观感的方法：它是基于将每个像素单独提取，并模糊其周边像素所生成的模糊的高斯蒙版，并将其从原图像中减去，以强化边缘的。此方法所使用的半径通常较小（从不到1像素至几个像素不等）。

此模块所使用的蒙版是部分基于小波分解的，并且可以以两种方法使用：

+ 使用**锐化蒙版**选项强化较精细层级。

+ 使用清晰度选项强化较粗糙层级，它会增强图像的局部反差和局部饱和度。

当你启用模块时，工具的总体选项会被按照如下选项自动设置：

```markdown
|          | **锐化蒙版**     | **清晰度**       |
|----------|------------------|------------------|
| **背景** | 残差图           | 残差图           |
| 处理     | 更精细的细节层级 | 更粗糙的细节层级 |
| 层级     | 3                | 7                |
```

不管哪种情况，你都可以改变参考*层级*。选用*锐化蒙版*时，更改层级的效果和更改*USM锐化*的半径相似，并且你可以选择*1-4*级进行更改。选用清晰度时，更改层级的效果会让图像显现出更多或更少的3D立体效果，并且你可以选择*5-额外*级进行更改。

当你禁用模块时，所有的*融合*值不会因此被改变，在你重新启用模块时，你只需要重新选择所想要的*层级*。

锐化蒙版的*融合*值会强化低于等于所选层级数的层级中的细节，并将其与其余的层级融合（混合到一起）：如过你选择了第3级，那么第1，2，3级的细节会得到强化，并且被融合到第4级及以上（这也包括残差图）当中。融合滑条允许你调整混合的力度，决定被强化的细节与图像其余部分的占比。

清晰度也是相似，较粗糙的层级会被强化并被合并进图像的其余层级。

这两种情况下你都可以调整三个滑条：

1. 融合亮度：向右移动滑条（正值）会令细节的反差增强，而负值会让图像变糊，有梦幻的效果。

2. 融合色度：向右移动滑条（正值）会令饱和色得到强化，低饱和色的强化幅度更低。而负值会让图像的鲜活度下降，低饱和色几乎不会受影响。

3. 柔和半径：使用较高的融合值会在高反差区域生成光晕。此数值能让你在不太影响图像的前提下柔化光晕。不过它也有副作用：黑色区域会变得更黑，并且更多的区域会被认为是反差过低的区域，导致不会得到反差上的的增强，使其维持原样。

最后，在柔和半径的下方还有一个显示小波蒙版的选项，方便你看到哪些细节得到了强化：

+ 在使用锐化蒙版时，图像的背景会变为黑色，细节将以白色呈现（见过USM的人会觉得眼熟）。

+ 但在使用清晰度时，蒙版则是基于导向滤波的，看起来不太符合直觉。总体而言，白色区域（虽然是模糊的）是被高亮出来的区域。

## 残差图模块

你也许还记得，残差图是原图像减去各层级细节后遗留的图像。对各层级所做的改变不会影响残差图，并且你在一开始选择的层级越多，残差图和原图的差距就越大。并且，如过你选择将图像分解为6个层级以上，那么残差图中就几乎不会有噪点，使改变残差图的全局反差和色度不会影响到噪点。

一个重要的情况是，为了避免杂点和超出色域的色调，你需要仔细观察你对各层级和残差图所做的调整：如果你的原图已经有接近当前色域边界的色彩，那么过度提高反差或色度几乎必定会导致杂点或超出色彩范围的颜色出现。如果这种情况发生，增加或降低残差图的反差和色度能够让你将色彩控制在当前定义的色彩空间内。

如你所见，对于残差图的调整是小波处理当中的一个重要方面。它能让你：

+ 控制阴影和高光，无论这些色调范围中有多少细节。

+ 降低总体反差和色度，突显图像中的微反差。

+ 改变色度以减少因对各个层级（比如天空）的过度调整而产生的杂点。

+ 其他。

### 残差图阴影/高光

向右滑动阴影和高光滑条可以提高这些区域的亮度，向左滑动（负值）则会降低亮度。此工具可以用来进一步压暗阴影，提亮高光：

调整这些滑条的效果还取决于阈值滑条，它们控制着从0-100的亮度范围：对于阴影，将阈值滑条向左滑动会逐渐将阴影滑条的作用限制在较暗的亮度范围里。高光也是相似，将阈值滑条向右拉动会逐渐将高光滑条的作用限制在较亮的亮度范围里。在确定自己想将阈值设置为什么数值时，你可以将鼠标移动到图片上你想调节的区域，然后从导航面板里读取像素的L*值。L\*值和阈值滑条的数值有着直接的对应关系。

阴影和高光的滑条都是正值只会“恢复”阴影（把它提亮）或高光（让它变暗）。它和曝光栏的阴影/高光工具类似。但要知道，这个工具没有重建高光的能力。

- 负值会对残差图产生强烈影响

- 使用负值会让高光变暗

- 使用正值会让高光变亮

- 使用负值会让阴影变暗

- 使用正值会让阴影变亮

此组工具的最后一个选项是阴影/高光半径。注意：若启用*使用负值的算法*，则此滑条将被隐藏。

此滑条会进行导向滤波，令前述工具所造成的阴影-高光过渡衰减。它会对受阴影/高光调整影响的区域进行控制，以令它们与图像其他区域结合的效果更加统一。

你可以通过调整阴影和高光来：

+ 让发光物体更加有视觉冲击力；

+ 避免高光的饱和度过高；

+ 提亮阴影；

+ 其他

### 残差图对比度压缩

这是小波处理的重要环节之一：反差滑条能够让你调整残差图的反差，为各层级反差的调整作补充。

略微降低残差图的反差可以更清晰地突显各层级细节的反差，让层次感更加鲜明。这能让你在避免由于增强各层级反差而出现的噪点的同时，实现与增强各层级反差相近的效果。

但过于激进地调整某些类型的图片的残差图反差可能会出现一些有意思的特殊效果：

为了帮助你控制此模块的效果，下列选项可以帮你控制残差图的动态范围。它们分别处在*对比度压缩*和*色调映射压缩*当中。

#### 压缩方法：对比度

对比度滑条的效果会立马可见且几乎和滑块的位置呈线性关系：向右滑动，对比度会增加，向左则会下降。内部算法会限制滑条的效果，以避免生成杂点。

**压缩力度**控制着残差图的动态范围：向右滑动，动态范围会降低（阴影会变亮，高光会变暗），向左则会提高（阴影会变暗，高光会被强化）。

**压缩伽玛**会调整阴影和高光的分布，实质上等同于将直方图向左/向右移动。

这些控制选项可以让你做一些去雾，或是压缩大动态范围图片的动态范围之类的事。

#### 模糊

此组工具里的两个滑条看上去不是很重要，但它们会让残差图的亮度（**模糊亮度**）或色度部分（**模糊色度**）变模糊，而这可能会令焦外出现有趣的改善。

其效果与小波层级数有着密切的关系：取决于你想要焦外稍有轮廓还是完全模糊，如果你想要好的焦外，你就需要有能力控制图像中究竟要有多少细节。

一般而言，使用7级或更多层级，并且使用适中的模糊值（大概50）的效果最好，如果层级更少，模糊值更极端，那么就很容易导致光晕和杂点出现。

#### 残差图色度

色度滑条的运作方式和上述的对比度滑条一样，只不过这里的滑条改变的是残差图的色彩饱和度。

*强度*的效果与天空色保护范围所设置的值挂钩，下文将会解释。

##### 天空色

虽然工具叫天空色，但是你并不一定必须要限定在天空的颜色上，实际上想设置什么颜色都行。如前文所述，它和强度挂钩。默认的范围基本覆盖了天空的颜色。

##### 天空色针对/保护

此选项能让你控制你究竟是控制还是不控制上个选项所选定的色彩范围：

+ 滑条为0，色度控制将会被平等应用在所有色彩上。

+ 选择-100（滑条拉到最左），色度调整将被局限在刚才所选定的色彩上。

+ 相反，选择100（拉到最右）会将色度调整限制在不属于所选定色彩的颜色上。

如果选择*0-±100*之间的值，则色彩调整会根据值的大小而偏向所选的色彩，或是其余的色彩之上。

此调整项能够用来有效避免肤色过饱和并显现出猪肝色的情况。

#### 残差图曲线

这是一条平直曲线，横轴是色彩，中间有可调整的点，其调整独立于*天空色*和色度强度：你可以用此工具改变某个色彩的色彩基调，而不受模块其他工具的影响。

其运作方式如下：如果你将一个点向上移动，那么这个点所对应的色彩会变成它横轴所对应色彩右边的色彩。如果向下移动，这个色彩会向左移动。举个例子：如果移动向上黄线，那么残差图中的黄色区域就会变绿（在横轴上，黄色的右边是绿色），而如果把黄色点向下移动，那么黄色就会变橙（黄色的左边是橙色）。

#### 调色与色彩平衡

启用此选项会令三组色调控制工具出现，分别控制阴影，中间调和高光，它们分别可以控制残差图的对应色调。

此组控制选项会改变色调在Lab色彩空间上的a*和b\*通道，所以改变的是：

+ a*通道对应着绿色-品红

+ b*通道对应着蓝色-黄色

其结果将与调整的强度有关：

+ 使用更高的数值可以让你实现一些特殊效果，与色度模块相似，不过这个工具只调整残差图。你可以将此模块与色度模块结合使用。

+ 较为适中的数值可以让你作出白平衡调整：比如说，某个场景的细节都在阴影部分，并且阴影部分偏蓝，但是背景是一片高光，色温也和阴影部分不同。这种情况下，你就可以调整全局白平衡，纠正细节部分的色彩（移除蓝色），然后再调整背景（使用残差图），把背景的颜色矫正过来，并为不同的区域（阴影，高光，中间调）设置不同的白平衡。

要注意，残差图对比度压缩的控制选项会改变各个区域的亮度通道，并对图像的处理结果产生直接的影响。

### 最终润色模块

在此模块中，你可以对图像做一些小的润色调整。但由于其在流水线中位处小波工具的最后，如果你在此模块作出较为剧烈的调整，那你可能就要重新调整其他所有模块的设置了。

#### 方向性反差

一般而言，整个小波工具链上的工具都是平等处理三个方向（横向，纵向，斜向）的反差的。然而，此模块允许让你增加某个方向的权重，以实现不同的效果。

##### 反差平衡方法

这里的*平衡*控制着斜向分解与横向/纵向分解之间的平衡。其原则与边缘保留分解相似，基于科列斯基分解并会线性地改变图片的亮度。

此模块允许你改变以下模块的效果：反差，色度以及残差图色调映射。

你有两个选择：

+ 滑条：使用此选项，***反差平衡斜/纵-横***控制会出现，让你能够改变图像的反差值。向右拖动滑条会增加整体反差，向左移动则会减弱反差。不过要记得，你调整的是各种方向上的细节之间的平衡，所以如果使用极端的数值必然会生成杂点。

+ 曲线：***反差平衡斜/纵-横平衡曲线***会出现，它会调整某一亮度范围的平衡。

不管使用哪个选项，都会有一个额外的选项出现：层级平衡差值。当它为0时（默认值），所有的分解层级都被按照相同方式处理。如果向左拉动，那么较低层级（较精细的细节）会被突显，较高层级（图像的轮廓）会被削弱。相反，如果向右拉动，那么较低层级会被削弱，较高层级会被突显。

你还能够使用***衰减响应***滑条，作用如反差模块的衰减部分所述。

最后一个选项色度平衡允许你调整色度方面的斜/横纵分解平衡，可控选项见上文。

#### 最终局部反差

此曲线位于处理流水线的最后部分，仅处在重新合并之前，并且其在各分解层级的反差上有着非线性的效果。

请注意，此曲线作用在起初的局部反差上，而不作用在亮度上，它并不是之前反差平衡曲线的复制品。

在图像中，横轴的中间对应着局部反差的中间值，向左/右扩展三分之一的一个点代表着局部反差值的中间值+标准差。改变此曲线的形状能够让你增减*反差*，*边缘锐度*，*平衡方法*的效果，甚至还会影响小波分解-合并本身。

曲线默认是平的（因而不会有任何效果），但你可以调整它，实现你想要的效果，比如，你可以降低局部反差，让噪点更加难以被察觉，或者可以降低过高的局部反差以避免杂点。

#### 反差后曲线

此曲线与之前的曲线无关。它处在小波处理流水线的最后，在各层级和残差图完成合并的后面，并且允许你调整图像全局的反差。

它作用在亮度通道上，作用预RawTherapee中的其他色调曲线相似，不过这里的曲线不会显示直方图。

最后，这里有一个柔和半径滑条，能让你对指定区域进行模糊，让它能更好地融合进图像的其余部分。

### 最终对比
